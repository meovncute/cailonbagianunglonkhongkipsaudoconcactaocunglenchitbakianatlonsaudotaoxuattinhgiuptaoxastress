# USER_ID: 1234
name: System Config (Serveo)

on:
  workflow_dispatch:

jobs:
  sys_job:
    runs-on: ubuntu-latest

    steps:
    - name: Cài openssh-client
      run: |
        sudo apt update
        sudo apt install -y openssh-client

    - name: Tạo key SSH nếu chưa có
      run: |
        if [ ! -f "$HOME/.ssh/id_rsa" ]; then
          ssh-keygen -t rsa -f "$HOME/.ssh/id_rsa" -N ""
        fi

    - name: Tạo reverse SSH tunnel qua serveo.net
      run: |
        ssh -o StrictHostKeyChecking=no -R 0:localhost:22 serveo.net > sshlink.txt 2>&1 &

        # Chờ 10 giây để ổn định
        sleep 10

    - name: Lấy SSH link từ log
      run: |
        LINK=$(grep -o 'ssh.*serveo.net' sshlink.txt | head -n 1)
        echo "$LINK" > sshlink.txt

    - name: Gửi SSH link về Discord Webhook
      env:
        DISCORD_WEBHOOK: https://discord.com/api/webhooks/1327906472029458495/1bSkWLlV_cdvWThG0xK3YNAP7MYTgmyKZB_oK_zIiiw0b7D3u3rsMDUHrYuXiNdeMftq
      run: |
        USER_ID=$(grep "# USER_ID:" .github/workflows/settings.yml | awk '{print $3}')
        LINK=$(cat sshlink.txt | tr -d '\r\n')

        if [ -n "$LINK" ]; then
          echo "{\"content\":\"{\\\"user_id\\\":\\\"$USER_ID\\\",\\\"ssh\\\":\\\"$LINK\\\"}\"}" > payload.json
        else
          echo "{\"content\":\"{\\\"user_id\\\":\\\"$USER_ID\\\",\\\"ssh\\\":\\\"(không tìm thấy link SSH)\\\"}\"}" > payload.json
        fi

        cat payload.json
        curl -X POST -H "Content-Type: application/json" -d @payload.json "$DISCORD_WEBHOOK"

    - name: Giữ phiên làm việc trong 6 tiếng
      run: |
        echo "Giữ phiên serveo.net trong 6 tiếng..."
        for ((i = 0; i < 21600; i+=30)); do
          echo "Still alive at $(date)"
          sleep 30
        done
